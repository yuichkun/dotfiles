#!/usr/bin/env node

const http = require("http");

const port = process.env.HOST_CMD_PORT;
if (!port) {
  console.error("Error: HOST_CMD_PORT environment variable not set");
  process.exit(1);
}

const args = process.argv.slice(2);
if (args.length === 0) {
  console.error("Usage: host-cmd <command> [args...]");
  process.exit(1);
}

const requestBody = JSON.stringify({ command: args });

const options = {
  hostname: "host.docker.internal",
  port: parseInt(port, 10),
  path: "/exec",
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Content-Length": Buffer.byteLength(requestBody),
  },
};

const req = http.request(options, (res) => {
  let data = "";

  res.on("data", (chunk) => {
    data += chunk;
  });

  res.on("end", () => {
    try {
      const response = JSON.parse(data);

      if (response.stdout) {
        process.stdout.write(response.stdout);
      }
      if (response.stderr) {
        process.stderr.write(response.stderr);
      }
      if (!response.success && response.error) {
        console.error(`Error: ${response.error}`);
      }

      process.exit(response.exitCode ?? (response.success ? 0 : 1));
    } catch (err) {
      console.error(`Failed to parse response: ${err.message}`);
      console.error(`Raw response: ${data}`);
      process.exit(1);
    }
  });
});

req.on("error", (err) => {
  console.error(`Request failed: ${err.message}`);
  process.exit(1);
});

req.write(requestBody);
req.end();
